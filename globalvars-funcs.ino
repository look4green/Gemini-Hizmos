#include <Arduino.h>
#include <U8g2lib.h>

// --- 1. GLOBAL CONTEXT & PLACEHOLDER DEFINITIONS ---
// NOTE: Replace U8G2_... with your specific display model and configuration.
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE); 

// Placeholder for the external animation frame data (nosd frames)
// Since the frame data itself (nosd1, nosd2, etc.) was not provided, 
// we must define placeholders for them to make the array declaration valid.
// In a real project, these would be defined in a header file or the main sketch.
const uint8_t nosd_dummy_frame[1024] U8X8_PROGMEM = {0x00}; // 128x64 pixels / 8 bits = 1024 bytes
#define nosd1 nosd_dummy_frame
#define nosd2 nosd_dummy_frame
#define nosd3 nosd_dummy_frame
#define nosd4 nosd_dummy_frame
#define nosd5 nosd_dummy_frame
#define nosd6 nosd_dummy_frame

// --- 2. FORWARD DECLARATIONS ---
void runLoop(void (*handler)());
void handlemainmenu(); // Placeholder for the function to return to
// Define the external messages for the start screen
static const unsigned char image_cards_hearts_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x1c,0x1c,0x3e,0x3e,0x7f,0x7f,0xff,0x7f,0xff,0x7f,0xff,0x7f,0xfe,0x3f,0xfc,0x1f,0xf8,0x0f,0xf0,0x07,0xe0,0x03,0xc0,0x01,0x80,0x00,0x00,0x00};
static const unsigned char image_wit201i_hizmos_oledhizmos_oled_bits[] U8X8_PROGMEM = {0x40,0x88,0x81,0x01,0x03,0xe0,0x9c,0x81,0x01,0x03,0xe0,0xdc,0xc3,0x83,0x07,0xa0,0xd4,0xff,0xff,0x07,0xf8,0xff,0xff,0xff,0x07,0x0c,0x00,0x00,0x00,0x08,0x0a,0x00,0x00,0x00,0x10,0xc9,0x00,0x00,0x00,0x13,0xc9,0x00,0x00,0x00,0x13,0x09,0x00,0x55,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0xc9,0xf1,0xff,0x87,0x1e,0x29,0x0a,0x00,0x08,0x1e,0x89,0x08,0x00,0x88,0x1e,0xc9,0x09,0x00,0x08,0x1e,0xe9,0x0b,0x00,0x88,0x1e,0x09,0x08,0x00,0x08,0x1e,0x09,0x08,0x00,0x88,0x1e,0x09,0x08,0x00,0x08,0x1e,0x09,0x08,0x00,0x88,0x1e,0x09,0x08,0x00,0x08,0x1e,0x09,0xf0,0xff,0x87,0x1e,0x09,0x00,0x00,0x00,0x1e,0x09,0x00,0x22,0x80,0x1e,0x09,0x00,0x3e,0x00,0x10,0x09,0x00,0x22,0x38,0x10,0x09,0x00,0x2a,0x38,0x10,0x09,0x00,0x22,0x38,0x10,0x09,0x00,0x3e,0x00,0x10,0x09,0x00,0x22,0x00,0x10,0x09,0x88,0x80,0x08,0x10,0x09,0xf8,0xbe,0x0f,0x10,0x09,0x88,0xa2,0x08,0x10,0x09,0xa8,0xaa,0x0a,0x10,0x09,0x88,0xa2,0x08,0x10,0x09,0xf8,0xbe,0x0f,0x10,0x09,0x88,0x80,0x08,0x10,0x09,0x00,0x3e,0x00,0x10,0x09,0x00,0x22,0x1f,0x10,0x09,0x00,0x2a,0x11,0x10,0x09,0x00,0x22,0x15,0x10,0x09,0x00,0x3e,0x11,0x10,0x09,0x00,0x22,0x1f,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0x09,0x00,0x00,0x00,0x10,0xc9,0x00,0x00,0x00,0x13,0xc9,0x00,0x3c,0x00,0x13,0x09,0x00,0x42,0x00,0x10,0x0a,0x00,0x42,0x00,0x08,0xfc,0xff,0xff,0xff,0x07};

// --- 3. UTILITY IMPLEMENTATION ---
// Placeholder for runLoop
void runLoop(void (*handler)()) {
  handler();
}

// Placeholder for main menu to return to
void handlemainmenu() {
    // This function would typically hold the main menu loop.
}

// --- 4. THE CORRECTED DISPLAY HANDLERS ---

/**
 * @brief Animates a "No SD Card" error screen.
 * This is meant to be called repeatedly by the main loop (via runLoop).
 */
void drawnosdcard() {
  // Array of frame pointers (using dummy placeholders defined above)
  const uint8_t* nosdFrames[] = {
    nosd1, nosd2, nosd3, nosd4, nosd5, nosd6
  };

  static uint8_t currentFrame = 0;
  static unsigned long lastUpdate = 0;
  const unsigned long frameDuration = 200; // ms per frame

  // Non-blocking frame update logic
  if (millis() - lastUpdate >= frameDuration) {
    lastUpdate = millis();
    currentFrame = (currentFrame + 1) % 6;  // loop through 0 to 5
  }

  u8g2.clearBuffer();
  // Draw the animation frame
  u8g2.drawXBMP(0, 0, 128, 64, nosdFrames[currentFrame]);
  
  // You might want to add exit logic here, e.g., if(digitalRead(BTN_BACK) == LOW) runLoop(handlemainmenu);

  u8g2.sendBuffer();
}

//----------------------------------------------------------------------

/**
 * @brief Animates a generic loading screen with an hourglass icon.
 * This is meant to be called repeatedly by the main loop (via runLoop).
 */
void loading() {
  // All hourglass frame data is placed here (Hourglass 0 to 6)
  static const unsigned char image_hourglass0_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0xe0,0xff,0x0f,0x20,0x00,0x08,0xc0,0xff,0x07,0x80,0x00,0x02,0x80,0xfe,0x02,0x80,0xfe,0x02,0x80,0x7c,0x02,0x00,0x39,0x01,0x00,0x92,0x00,0x00,0x44,0x00,0x00,0x28,0x00,0x00,0x28,0x00,0x00,0x44,0x00,0x00,0x92,0x00,0x00,0x01,0x01,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0xc0,0xff,0x07,0x20,0x00,0x08,0xe0,0xff,0x0f,0x00,0x00,0x00};
  static const unsigned char image_hourglass1_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0xe0,0xff,0x0f,0x20,0x00,0x08,0xc0,0xff,0x07,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0xfe,0x02,0x80,0x7c,0x02,0x00,0x39,0x01,0x00,0x92,0x00,0x00,0x44,0x00,0x00,0x28,0x00,0x00,0x28,0x00,0x00,0x44,0x00,0x00,0x92,0x00,0x00,0x01,0x01,0x80,0x10,0x02,0x80,0x7c,0x02,0x80,0xfe,0x02,0x80,0x00,0x02,0xc0,0xff,0x07,0x20,0x00,0x08,0xe0,0xff,0x0f,0x00,0x00,0x00};
  static const unsigned char image_hourglass2_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0xe0,0xff,0x0f,0x20,0x00,0x08,0xc0,0xff,0x07,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x7c,0x02,0x00,0x39,0x01,0x00,0x92,0x00,0x00,0x44,0x00,0x00,0x28,0x00,0x00,0x28,0x00,0x00,0x44,0x00,0x00,0x92,0x00,0x00,0x01,0x01,0x80,0x7c,0x02,0x80,0xfe,0x02,0x80,0xfe,0x02,0x80,0x00,0x02,0xc0,0xff,0x07,0x20,0x00,0x08,0xe0,0xff,0x0f,0x00,0x00,0x00};
  static const unsigned char image_hourglass3_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0xe0,0xff,0x0f,0x20,0x00,0x08,0xc0,0xff,0x07,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0x00,0x01,0x01,0x00,0x82,0x00,0x00,0x44,0x00,0x00,0x28,0x00,0x00,0x28,0x00,0x00,0x44,0x00,0x00,0x92,0x00,0x00,0x39,0x01,0x80,0x7c,0x02,0x80,0xfe,0x02,0x80,0xfe,0x02,0x80,0x00,0x02,0xc0,0xff,0x07,0x20,0x00,0x08,0xe0,0xff,0x0f,0x00,0x00,0x00};
  static const unsigned char image_hourglass4_bits[] U8X8_PROGMEM = {0x00,0x02,0x00,0x00,0x07,0x00,0x80,0x02,0x00,0x40,0x05,0x00,0xa0,0x08,0x00,0x50,0x10,0x00,0x28,0x10,0x00,0x14,0x10,0x00,0x0a,0x10,0x00,0x07,0x10,0x00,0x0a,0x10,0x00,0x10,0xe0,0x07,0xe0,0x07,0x08,0x00,0x28,0x50,0x00,0xe8,0xe7,0x00,0xe8,0x53,0x00,0xe8,0x29,0x00,0xe8,0x14,0x00,0x48,0x0a,0x00,0x10,0x05,0x00,0xa0,0x02,0x00,0x40,0x01,0x00,0xe0,0x00,0x00,0x40,0x00};
  static const unsigned char image_hourglass5_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x60,0x0a,0x00,0x50,0xfa,0x00,0x5f,0x0a,0x81,0x50,0x0a,0x42,0x50,0x0a,0x24,0x50,0x0a,0x18,0x5e,0x0a,0xc0,0x5f,0x0a,0x98,0x5f,0x0a,0x24,0x5f,0x0a,0x42,0x5e,0x0a,0x81,0x50,0xfa,0x00,0x5f,0x0a,0x00,0x50,0x06,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  static const unsigned char image_hourglass6_bits[] U8X8_PROGMEM = {0x00,0x40,0x00,0x00,0xe0,0x00,0x00,0x40,0x01,0x00,0xa0,0x02,0x00,0x10,0x05,0x00,0x08,0x0a,0x00,0x08,0x14,0x00,0xc8,0x29,0x00,0xe8,0x53,0x00,0xe8,0xe7,0x00,0xe8,0x53,0xe0,0x07,0x08,0x10,0xe0,0x07,0x0a,0x10,0x00,0x07,0x10,0x00,0x0a,0x10,0x00,0x14,0x10,0x00,0x28,0x10,0x00,0x50,0x10,0x00,0xa0,0x08,0x00,0x40,0x05,0x00,0x80,0x02,0x00,0x00,0x07,0x00,0x00,0x02,0x00};
  
  // The generic hourglass icon is not used in the animation sequence but defined here for reference.
  // static const unsigned char image_LoadingHourglass_bits[] U8X8_PROGMEM = {0x00,0x00,0x00,0xe0,0xff,0x0f,0x20,0x00,0x08,0xc0,0xff,0x07,0x80,0x00,0x02,0x80,0xaa,0x02,0x80,0x54,0x02,0x80,0x28,0x02,0x00,0x11,0x01,0x00,0x82,0x00,0x00,0x54,0x00,0x00,0x28,0x00,0x00,0x28,0x00,0x00,0x44,0x00,0x00,0x92,0x00,0x00,0x01,0x01,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0x80,0x00,0x02,0xc0,0xff,0x07,0x20,0x00,0x08,0xe0,0xff,0x0f,0x00,0x00,0x00};

  static const unsigned char* hourglass_frames[] = {
    image_hourglass0_bits,
    image_hourglass1_bits,
    image_hourglass2_bits,
    image_hourglass3_bits,
    image_hourglass4_bits,
    image_hourglass5_bits,
    image_hourglass6_bits
  };
  static const int num_frames = sizeof(hourglass_frames) / sizeof(hourglass_frames[0]);
  static int current_frame = 0;
  static unsigned long last_frame_time = 0;
  const unsigned long frame_interval = 300; // 300ms delay between frames

  unsigned long now = millis();

  // Non-blocking frame update logic
  if (now - last_frame_time >= frame_interval) {
    last_frame_time = now;
    current_frame = (current_frame + 1) % num_frames;
  }

  u8g2.clearBuffer();
  u8g2.setFontMode(1);
  u8g2.setBitmapMode(1);

  // Draw current hourglass frame (24x24 pixels)
  // Centered position (128/2 - 24/2 = 64 - 12 = 52, using 49 for minor adjustment)
  u8g2.drawXBMP(52, 10, 24, 24, hourglass_frames[current_frame]);

  // Draw loading text
  u8g2.setFont(u8g2_font_t0_16b_tr); // Note: Assuming a definition for this font exists
  u8g2.drawStr(32, 55, "LOADING..."); // Centered text adjusted

  u8g2.sendBuffer();
}

//----------------------------------------------------------------------

/**
 * @brief Draws the fixed application start information/splash screen.
 */
void drawstartinfo() {
    u8g2.clearBuffer();
    u8g2.setFontMode(1);
    u8g2.setBitmapMode(1);
    
    // --- Drawing the Splash Screen Elements ---
    
    // wit201i#hizmos_oledhizmos_oled (Logo)
    // Draw an image of a multi-layer PCB with components and RF traces
    u8g2.drawXBMP(3, 6, 37, 53, image_wit201i_hizmos_oledhizmos_oled_bits);

    // Text Layers
    // Layer 1: Title
    u8g2.setFont(u8g2_font_profont17_tr); // Assuming definition exists
    u8g2.drawStr(44, 19, "HIZMOS V1");

    // Layer 4: Multitool
    u8g2.setFont(u8g2_font_timR12_tr); // Assuming definition exists
    u8g2.drawStr(50, 36, "multitool");

    // Layer 3: Author
    u8g2.setFont(u8g2_font_haxrcorp4089_tr); // Assuming definition exists
    u8g2.drawStr(55, 55, "by HIKTRON");

    // cards_hearts icon (15x16)
    u8g2.drawXBMP(107, 43, 15, 16, image_cards_hearts_bits);

    u8g2.sendBuffer();
}
